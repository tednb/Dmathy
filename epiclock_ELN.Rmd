---
title: "CLOCK"
output:
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
knitr::opts_knit$set(root.dir = "/mnt/local-disk/data/guoxiaolong/Renv")
```

```{r data}
load("~/data/infinium/liver_sample/341_liver_samples/RData/GSE180474_he.Rd")
load("~/data/infinium/liver_sample/341_liver_samples/RData/dmct_hc.Rd")
source("~/code/Dmathy/ELN_clock.R")

```

Sorting hepatocytes' age-DMCs by \|PCC\| \>= 0.3 (FOR SCAGE)

```{r}
he_adc <- rownames(dmct_hc)[dmct_hc$Hep == 1 | dmct_hc$Hep == -1]
idx <- match(he_adc,rownames(he.o@m))
m <- he.o@m[idx,]
age <- he.o@s$age
r <- apply(m,1,function(x) {cor(x,age,method = "pearson")})

den <- density(abs(r))
plot(den)

r_ref <- r[abs(r) >= 0.3]
save(r_ref,file = "~/data/infinium/liver_sample/341_liver_samples/RData/AC_pcc.Rdata")
```

1.  Randomly sampling 70% of total 210 samples as a training dataset (150).

```{r}
dmct_hc <- dmct_hc[,c(2,4)]
he.o@name <- "GSE180474"
sets <- extract(he.o,seed = 1234)
trainset <- sets[[1]]
testset <- sets[[2]]
clocks <- clock(trainset,dmct_hc)
testset@GSE <- "GSE180474"
age_pre <- validate(testset,clocks)
```

2.  Validation: Bulk

```{r}
# GSE107038: 40
load("~/data/infinium/liver_sample/40_normal_liver_samples/GSE107038_qc.Rd")
pip_pre(qc_107038.o,trainset,dmct_hc)
# GSE61446
load("~/data/infinium/liver_sample/67_obese_livers/GSE61446/GSE61446_qc.Rd")
pip_pre(qc.o,trainset,dmct_hc)
# GSE61258
load("~/data/infinium/liver_sample/79_livers(25_healthy)/GSE61258/GSE61258_qc.Rd")
disease <- as.factor(qc.o@s$disease)
age <- qc.o@s$age
age_pre <- pip_pre(qc.o,trainset,dmct_hc)

# There are 6 levels of disease: 0,1,2,3,4,5, which represent Healthy,HealthyObese,NAFLD,PBC,PSC and NASH.
# NOW we plot scatterplot for age_pre against age_t and color the points by disease.
for (i in 1:length(age_pre)){
cell <- names(age_pre)[[i]]
cor <- cor(age_pre[[i]][,1],age,method = "pearson")
p <- cor.test(age_pre[[i]][,1],age)$p.value
MAE <- median(abs(age_pre[[i]][,1]-age))
# Output PDF files for this cell type
pdf(paste0(cell," GSE61258.pdf"))
# Plot the predicted age and real age with a 45 degree dashed line and a mark of correlation and RMSE
plot(age,age_pre[[i]][,1],col=disease,pch=19,xlab="Chronological age (years)",ylab = "Predicted age (years)",xlim = c(10,80),ylim = c(10,80),main = paste0(cell," clock"))
abline(0,1,lty = 2)
text(20,40,paste0("r = ",format(cor, digits = 3),"\n","p = ",format(p, digits = 1),"\n","MedAE: ",format(MAE, digits = 2),"years"))
# ADD a legend for the color
legend("topleft",legend = c("Healthy","HealthyObese","NAFLD","PBC","PSC","NASH")
       ,col = c(1,2,3,4,5,6),pch = 19)
dev.off()
}
# BUILD-UP SAMPLE
load("~/data/infinium/liver_sample/combine_64_he_samples/107038+61258.Rd")
age_pre <- pip_pre(qc.on,trainset,dmct_hc)
```

3.  Validation: Sort

```{r}
load("~/data/infinium/liver_sample/AA_hepatocytes/GSE123995_qc.Rd")
age_pre <- pip_pre(qc.o,trainset,dmct_hc)
```

4.  benchmarking

```{r}
all_c <- rep(1,nrow(he.o@m))
# Build a data frame with only 1 column using all_c and using the same rownames as he.o@m
dmct_ben <- data.frame(all_c, row.names = rownames(he.o@m))
colnames(dmct_ben) <- "all"
clocks_ben <- clock(trainset,dmct_ben)
age_pre <- validate(testset,clocks_ben)

pip_pre(qc_107038.o,trainset,dmct_ben)
load("~/data/infinium/liver_sample/67_obese_livers/GSE61446/GSE61446_qc.Rd")
pip_pre(qc.o,trainset,dmct_ben)

load("~/data/infinium/liver_sample/79_livers(25_healthy)/GSE61258/GSE61258_qc.Rd")
disease <- as.factor(qc.o@s$disease)
age <- qc.o@s$age
age_pre <- pip_pre(qc.o,trainset,dmct_ben)

# There are 6 levels of disease: 0,1,2,3,4,5, which represent Healthy,HealthyObese,NAFLD,PBC,PSC and NASH.
# NOW we plot scatterplot for age_pre against age_t and color the points by disease.
for (i in 1:length(age_pre)){
cell <- names(age_pre)[[i]]
cor <- cor(age_pre[[i]][,1],age,method = "pearson")
p <- cor.test(age_pre[[i]][,1],age)$p.value
MAE <- median(abs(age_pre[[i]][,1]-age))
# Output PDF files for this cell type
pdf(paste0(cell," GSE61258.pdf"))
# Plot the predicted age and real age with a 45 degree dashed line and a mark of correlation and RMSE
plot(age,age_pre[[i]][,1],col=disease,pch=19,xlab="Chronological age (years)",ylab = "Predicted age (years)",xlim = c(10,80),ylim = c(10,80),main = paste0(cell," clock"))
abline(0,1,lty = 2)
text(20,40,paste0("r = ",format(cor, digits = 3),"\n","p = ",format(p, digits = 1),"\n","MedAE: ",format(MAE, digits = 2),"years"))
# ADD a legend for the color
legend("topleft",legend = c("Healthy","HealthyObese","NAFLD","PBC","PSC","NASH")
       ,col = c(1,2,3,4,5,6),pch = 19)
dev.off()
}
# BUILD-UP SAMPLE
load("~/data/infinium/liver_sample/combine_64_he_samples/107038+61258.Rd")
age_pre <- pip_pre(qc.on,trainset,dmct_ben)

load("~/data/infinium/liver_sample/AA_hepatocytes/GSE123995_qc.Rd")
age_pre <- pip_pre(qc.o,trainset,dmct_ben)
```

5.  Validating on CD4T and CD8T: GSE71955

```{r}
library(EpiDISH)
BloodFrac.m <- epidish(beta.m = cd4_qc.o@m, ref.m = centDHSbloodDMC.m, method = "RPC")$estF
cd4_qc.o@ctf.o <- list(BloodFrac.m,boxplot(BloodFrac.m))
BloodFrac.m <- epidish(beta.m = cd8_qc.o@m, ref.m = centDHSbloodDMC.m, method = "RPC")$estF
cd8_qc.o@ctf.o <- list(BloodFrac.m,boxplot(BloodFrac.m))
save(cd4_qc.o,file = "CD4_qc.Rd")
save(cd8_qc.o,file = "CD8_qc.Rd")

age_pre <- pip_pre(cd4_qc.o,trainset,dmct_hc)
age_pre <- pip_pre(cd8_qc.o,trainset,dmct_hc)
```

6.  Validating on kidney , colon and prostate

```{r}
# kidney
age_pre <- pip_pre(qc.o,trainset,dmct_hc)
# prostate
age_pre <- pip_pre(hey.o,trainset,dmct_hc)
# colon
age_pre <- pip_pre(he.o,trainset,dmct_hc)
```
